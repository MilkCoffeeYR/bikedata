# The sysdata.rda object

## DC station locations

The function `R/stations.R/bike_get_dc_stations` has code to extract and process
DC stations. The data can be obtained from 
http://opendata.dc.gov/datasets/capital-bike-share-locations/, using
Download->Spreadsheet. The code is reproduced here
```{r}
stations_dc <- read.csv ("Capital_Bike_Share_Locations.csv")
names (stations_dc) <- tolower (names (stations_dc))
name <- noquote (gsub ("'", "", stations_dc$address)) #nolint
name <- trimws (name, which = 'right') # trim terminal white space
stations_dc <- data.frame (id = stations_dc$terminal_number,
                           name = name,
                           lon = stations_dc$longitude,
                           lat = stations_dc$latitude,
                           stringsAsFactors = FALSE)
```

Script to generate the internal `bike_headers.rda` `data.frame` object which is
used to parse the data. These header data are only used to specify file
structure within the `C++` routines, and data for new cities may be added by
specifying the correponding structure here, recreating the `bike_headers.rda`
file, and modifying the **R** code as detailed in the [`bikedata`
wiki](https://github.com/ropensci/bikedata/wiki/How-to-add-a-new-city).

This first bit of code specifies the structures for the cities, with the C++
code then just referencing the following numbers for each field:
| number | field                   |
| ----   | ----------------------- |
| 0      | duration                |
| 1      | start_time              |
| 2      | end_time                |
| 3      | start_station_id        |
| 4      | start_station_name      |
| 5      | start_station_latitude  |
| 6      | start_station_longitude |
| 7      | end_station_id          |
| 8      | end_station_name        |
| 9      | end_station_latitude    |
| 10     | end_station_longitude   |
| 11     | bike_id                 |
| 12     | user_type               |
| 13     | birth_year              |
| 14     | gender                  |
Note that the `field_names` are not actually used, so do not necessarily have to
agree entirely with the values as given.
```{r}
fields <- c ("duration", "start_time", "end_time",
             "start_station_id", "start_station_name",
             "start_station_latitude", "start_station_longitude",
             "end_station_id", "end_station_name",
             "end_station_latitude", "end_station_longitude",
             "bike_id", "user_type", "birth_year", "gender")
nfields <- length (fields) # 15

dat_sf <- data.frame (fields = fields)
dat_sf$city <- "sf"
dat_sf$field_names <- c ("duration_sec", "start_time", "end_time",
                      "start_station_id", "start_station_name",
                      "start_station_latitude", "start_station_longitude",
                      "end_station_id", "end_station_name",
                      "end_station_latitude", "end_station_longitude",
                      "bike_id", "user_type",
                      "member_birth_year", "member_gender")
dat_sf$quoted <- c (FALSE, TRUE, TRUE, FALSE, TRUE, FALSE, FALSE, FALSE, TRUE,
                    FALSE, FALSE, FALSE, TRUE, FALSE, TRUE)
dat_sf$position <- 1:15
dat_sf$do_stations <- rep (TRUE, 15)

# file format 2011-2015
dat_bo1 <- data.frame (fields = fields)
dat_bo1$city <- "bo1"
dat_bo1$field_names <- c ("tripduration", "starttime", "stoptime",
                          "start station id", "start station name",
                          "start station latitude", "start station longitude",
                          "end station id", "end station name",
                          "end station latitude", "end station longitude",
                          "bikeid", "usertype", "birth year", "gender")
dat_bo1$quoted <- c (FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,
                     FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE)
dat_bo1$position <- seq (nfields)
dat_bo1$do_stations <- rep (FALSE, nfields)

# file format 2016-2017
dat_bo2 <- data.frame (fields = fields)
dat_bo2$city <- "bo2"
dat_bo2$field_names <- c ("tripduration", "starttime", "stoptime",
                          "start station id", "start station name",
                          "start station latitude", "start station longitude",
                          "end station id", "end station name",
                          "end station latitude", "end station longitude",
                          "bikeid", "usertype", "birth year", "gender")
dat_bo2$quoted <- c (FALSE, TRUE, TRUE, FALSE, TRUE, FALSE, FALSE,
                     FALSE, TRUE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE)
dat_bo2$position <- seq (nfields)
dat_bo2$do_stations <- rep (FALSE, nfields)

# file format 2018
dat_bo3 <- data.frame (fields = fields)
dat_bo3$city <- "bo3"
dat_bo3$field_names <- c ("tripduration", "starttime", "stoptime",
                          "start station id", "start station name",
                          "start station latitude", "start station longitude",
                          "end station id", "end station name",
                          "end station latitude", "end station longitude",
                          "bikeid", "usertype", "birth year", "gender")
dat_bo3$quoted <- c (TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE,
                     TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE)
dat_bo3$position <- seq (nfields)
dat_bo3$do_stations <- rep (FALSE, nfields)

# file format 2013-2016Q2, then 2017Q4-
dat_ch1 <- data.frame (fields = fields)
dat_ch1$city <- "ch1"
dat_ch1$field_names <- c ("tripduration", "starttime", "stoptime",
                          "from_station_id", "from_station_name", "", "",
                          "to_station_id", "to_station_name", "", "",
                          "bikeid", "usertype", "birthday", "gender")
dat_ch1$quoted <- rep (FALSE, nfields)
dat_ch1$position <- c (5, 2, 3, 6, 7, -1, -1, 8, 9, -1, -1, 4, 10, 11, 12)
dat_ch1$do_stations <- rep (FALSE, nfields)

# file format 2016Q3-2017Q3
dat_ch2 <- dat_ch1
dat_ch2$quoted <- rep (TRUE, nfields)

headers <- rbind (dat_sf, dat_bo1, dat_bo2, dat_bo3, dat_ch1, dat_ch2)
```
And this then saves the correponding `data.frame` to the package data:
```{r}
data_dir <- file.path (here::here (), "R")
f <- file.path (data_dir, "sysdata.rda")
load ("./R/sysdata.rda")
stations_dc <- sysdata$stations_dc # comment out to refresh using above code
sysdata <- list (stations_dc = stations_dc, headers = headers)
save (sysdata, file = f, compress = "xz")
```
